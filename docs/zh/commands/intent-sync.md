# /intent-sync

> 将最终实现细节同步回 Intent

## 用法

```bash
/intent-sync
/intent-sync path/to/INTENT.md
```

## 目的

实现完成且测试通过后，此命令将确认的细节同步回 Intent 文档。这保持 Intent 作为准确的真相来源。

## 何时使用

- 实现完成
- 所有测试通过
- API 签名或数据结构在实现过程中发生了变化
- 做出了应该记录的架构决策

## 同步内容

| 类别 | 示例 |
|------|------|
| **API 签名** | 最终参数类型，返回类型 |
| **数据结构** | 实际字段名，类型 |
| **命名约定** | 实现的类名，函数名 |
| **架构决策** | 选择的模式，使用的库 |
| **发现的约束** | 实现过程中发现的限制 |

## 同步流程

```
┌─────────────────────────────────────────────────────────────┐
│                     /intent-sync                             │
│                                                              │
│  ┌────────────────────────────────────────────────────┐     │
│  │ 步骤 1：分析实现                                    │     │
│  │ - 读取源文件                                       │     │
│  │ - 提取签名、类型、结构                             │     │
│  │ - 识别使用的模式                                   │     │
│  └────────────────────────┬───────────────────────────┘     │
│                           ▼                                  │
│  ┌────────────────────────────────────────────────────┐     │
│  │ 步骤 2：与 Intent 比较                             │     │
│  │ - 找出差异                                         │     │
│  │ - 分类：添加、修改、删除                           │     │
│  └────────────────────────┬───────────────────────────┘     │
│                           ▼                                  │
│  ┌────────────────────────────────────────────────────┐     │
│  │ 步骤 3：展示变更                                   │     │
│  │ - 显示每个章节的差异                               │     │
│  │ - 请求确认                                         │     │
│  └────────────────────────┬───────────────────────────┘     │
│                           ▼                                  │
│  ┌────────────────────────────────────────────────────┐     │
│  │ 步骤 4：应用更新                                   │     │
│  │ - 更新 Intent 文件                                 │     │
│  │ - 标记章节为 [synced]                              │     │
│  └────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────┘
```

## 示例会话

```
> /intent-sync intent/auth/INTENT.md

分析实现...
找到：src/auth/service.ts, src/auth/middleware.ts

与 Intent 比较...

## 发现的差异

### API 章节

**原始 Intent：**
\```
### validateToken(token)
返回：boolean
\```

**实际实现：**
\```typescript
validateToken(token: string): TokenValidationResult {
  // 返回带有 isValid, userId, expiresAt 的对象
}
\```

**提议的更新：**
\```
### validateToken(token)

**参数：**
- token: string - 要验证的 JWT 令牌

**返回：** TokenValidationResult
- isValid: boolean
- userId: string | null
- expiresAt: Date | null

**错误：**
- MalformedTokenError: 当令牌格式无效时
\```

应用此更新？[y/n/编辑]
> y

✓ API 章节已更新

### 结构章节

**检测到添加：** 错误处理层

\```
原始：
┌─────────────┐     ┌─────────────┐
│  Middleware │────▶│  AuthService│
└─────────────┘     └─────────────┘

提议：
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  Middleware │────▶│ ErrorHandler│────▶│  AuthService│
└─────────────┘     └─────────────┘     └─────────────┘
\```

应用此更新？[y/n/编辑]
> y

✓ 结构章节已更新

## 同步总结

| 章节 | 状态 |
|------|------|
| 职责 | 无变更 |
| 结构 | 已更新 |
| API | 已更新 |
| 示例 | 无变更 |

Intent 同步成功。
```

## 同步 vs 原始 Intent

| 方面 | 原始 Intent | 同步后 |
|------|-------------|--------|
| **角色** | 设计文档 | 实现记录 |
| **准确性** | 理想化 | 已验证 |
| **来源** | 人工设计 | 代码派生 |

## 最佳实践

1. **测试通过后再同步** - 不要同步损坏的实现
2. **审查每个变更** - 不要自动应用所有内容
3. **保留设计意图** - 同步事实，保留理念
4. **记录原因** - 如果实现有显著差异，注明原因

## 相关命令

- [/intent-build-now](intent-build-now.md) - 同步前构建
- [/intent-check](intent-check.md) - 同步后验证
- [/intent-review](intent-review.md) - 如有重大变更重新审查

## 另请参阅

- [IDD 工作流程](../workflow.md) - 同步在生命周期中的位置
- [Intent 标准](../intent-standard.md) - 文件格式
